name: doc-test

on:
  workflow_call:
    inputs:
      matrix:
        description: 'Distribution to execute tests on'
        required: true
        type: string
      latest:
        description: 'Use latest arch-defs packages'
        required: false
        type: boolean
        default: false

jobs:


  Test:
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(inputs.matrix) }}
    runs-on: ${{ matrix.runs-on }}
    name: ${{ matrix.name }}

    env:
      GHA_PREEMPTIBLE: "false"
      SURELOG_CMD: ${{ matrix.surelog }}

    steps:

      - name: Setup repository
        uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Pull container image
        run: docker pull ${{matrix.image}}

      - name: Patch package URLs
        if: inputs.latest == true
        run: |
          sudo apt update -qq
          sudo apt install -y patch
          patch -p1 -i .github/latest.patch

      - name: Build examples
        # Workaround for 'uses: docker://${{matrix.image}}' not being supported.
        # See https://github.com/github/feedback/discussions/9049
        run: >-
          docker run --rm
          -v $(pwd):/wrk -w /wrk
          -e DEBIAN_FRONTEND="noninteractive"
          ${{matrix.image}}
          bash .github/scripts/build-examples.sh ${{matrix.fpga-fam}} ${{matrix.example}}

#      - uses: actions/upload-artifact@v3
#        with:
#          name: f4pga-examples-bitstreams-${{ matrix.name }}
#          path: '**/*.bit'
#
#      - uses: actions/upload-artifact@v3
#        with:
#          name: f4pga-examples-plots-${{ matrix.name }}
#          path: '**/plot_*.svg'
